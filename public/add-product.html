<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>惠多多 - 发布商品</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .form-container {
            max-width: 800px;
            margin: 40px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .form-group textarea {
            height: 120px;
            resize: vertical;
        }
        .btn-submit {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
        }
        .btn-submit:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand huiddo-brand" onclick="window.location.href='/'" style="cursor:pointer;">惠多多</div>
        <div class="nav-actions">
            <div class="nav-item" onclick="window.location.href='/'">
                <i class="fas fa-home"></i> 返回首页
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="form-container">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">
                <i class="fas fa-plus-circle"></i> 发布新商品
            </h2>
            <form id="addProductForm">
                <div class="form-group">
                    <label for="name">商品名称</label>
                    <input type="text" id="name" required placeholder="请输入商品名称">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="form-group">
                        <label for="price">价格 (¥)</label>
                        <input type="number" id="price" required min="0" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label for="stock">库存数量</label>
                        <input type="number" id="stock" required min="1" placeholder="100">
                    </div>
                </div>

                <div class="form-group">
                    <label for="category">商品分类</label>
                    <select id="category" required>
                        <option value="">请选择分类</option>
                        <option value="Electronics">电子数码</option>
                        <option value="Clothing">服饰鞋包</option>
                        <option value="Home">家居生活</option>
                        <option value="Books">图书文具</option>
                        <option value="Beauty">美妆护肤</option>
                        <option value="Food">食品生鲜</option>
                        <option value="Sports">运动户外</option>
                        <option value="Other">其他</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="description">商品描述</label>
                    <textarea id="description" required placeholder="请输入商品详细描述..."></textarea>
                </div>

                <div class="form-group" id="merchantGroup">
                    <label for="merchantName">店铺名称</label>
                    <input type="text" id="merchantName" required placeholder="请输入店铺名称">
                    <input type="hidden" id="merchantId">
                </div>

                <div class="form-group" id="adminMerchantSelect" style="display: none;">
                    <label>选择店铺</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="merchantSelect" style="flex: 1;">
                            <option value="">请选择店铺...</option>
                        </select>
                        <button type="button" onclick="openNewShopModal()" style="padding: 0 15px; background: #2ecc71; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-plus"></i> 新建
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label>商品图片</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="imageType" value="url" checked onchange="toggleImageInput()"> 网络图片链接
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="radio" name="imageType" value="file" onchange="toggleImageInput()"> 本地上传
                        </label>
                    </div>
                    
                    <div id="urlInputGroup">
                        <input type="url" id="imageUrl" placeholder="https://example.com/image.jpg">
                    </div>
                    
                    <div id="fileInputGroup" style="display: none;">
                        <input type="file" id="imageFile" accept="image/*">
                    </div>
                    <p style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">* 建议使用正方形图片，支持 jpg, png 格式</p>
                </div>

                <div class="form-group">
                    <label for="productCode">商品编码 (选填)</label>
                    <input type="text" id="productCode" placeholder="例如: PROD-001">
                </div>

                <div class="form-group">
                    <label for="searchKeywords">搜索关键词 (选填, 用逗号分隔)</label>
                    <input type="text" id="searchKeywords" placeholder="例如: 手机,智能,5G">
                </div>

                <button type="button" class="btn-submit" onclick="submitProduct(event)">
                    <i class="fas fa-check"></i> 立即发布
                </button>
            </form>
        </div>
    </div>

    <!-- New Shop Modal -->
    <div id="newShopModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; width: 400px; max-width: 90%;">
            <h3 style="margin-top: 0;">新建店铺</h3>
            <form id="newShopForm">
                <div class="form-group">
                    <label>店铺名称</label>
                    <input type="text" id="newShopName" required>
                </div>
                <div class="form-group">
                    <label>店主姓名</label>
                    <input type="text" id="newOwnerName" required>
                </div>
                <div class="form-group">
                    <label>登录邮箱</label>
                    <input type="email" id="newEmail" required>
                </div>
                <div class="form-group">
                    <label>登录密码</label>
                    <input type="password" id="newPassword" required>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" onclick="document.getElementById('newShopModal').style.display='none'" style="padding: 8px 15px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">取消</button>
                    <button type="submit" style="padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">创建</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // 检查登录状态
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                alert('请先登录');
                window.location.href = '/login.html';
                return;
            }

            const user = JSON.parse(userStr);
            // 允许管理员和商家发布商品
            if (user.role !== 'admin' && user.role !== 'merchant') {
                alert('您没有权限发布商品');
                window.location.href = '/';
                return;
            }

            // Admin specific logic
            if (user.role === 'admin') {
                document.getElementById('merchantGroup').style.display = 'none';
                document.getElementById('adminMerchantSelect').style.display = 'block';
                // merchantName is hidden for admin - remove required to avoid validation errors
                const mn = document.getElementById('merchantName');
                if (mn) mn.required = false;
                await loadMerchants();
            } else {
                // Pre-fill merchant name for merchant users
                const merchantNameInput = document.getElementById('merchantName');
                if (merchantNameInput) {
                    merchantNameInput.value = user.merchantInfo?.shopName || user.name;
                    merchantNameInput.readOnly = true; // Merchants can't change shop name here
                }
                document.getElementById('merchantId').value = user.id;
            }

            // Toggle image input
            window.toggleImageInput = function() {
                const type = document.querySelector('input[name="imageType"]:checked').value;
                document.getElementById('urlInputGroup').style.display = type === 'url' ? 'block' : 'none';
                document.getElementById('fileInputGroup').style.display = type === 'file' ? 'block' : 'none';
            };

            // New Shop Modal Logic
            window.openNewShopModal = function() {
                document.getElementById('newShopModal').style.display = 'flex';
            };

            document.getElementById('newShopForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    const data = {
                        name: document.getElementById('newOwnerName').value,
                        email: document.getElementById('newEmail').value,
                        password: document.getElementById('newPassword').value,
                        shopName: document.getElementById('newShopName').value
                    };
                    
                    const response = await fetch('/api/merchants', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        const newMerchant = await response.json();
                        alert('店铺创建成功');
                        document.getElementById('newShopModal').style.display = 'none';
                        await loadMerchants(); // Reload list
                        document.getElementById('merchantSelect').value = newMerchant._id; // Auto select
                    } else {
                        const err = await response.json();
                        alert('创建失败: ' + err.message);
                    }
                } catch (error) {
                    console.error(error);
                    alert('创建出错');
                }
            });

            async function loadMerchants() {
                try {
                    const response = await fetch('/api/merchants');
                    const merchants = await response.json();
                    const select = document.getElementById('merchantSelect');
                    select.innerHTML = '<option value="">请选择店铺...</option>' + 
                        merchants.map(m => `<option value="${m._id}" data-name="${m.merchantInfo?.shopName || m.name}">${m.merchantInfo?.shopName || m.name}</option>`).join('');
                } catch (error) {
                    console.error('加载店铺失败', error);
                }
            }

            // 表单提交处理（封装为函数，按钮直接调用作为回退）
            const form = document.getElementById('addProductForm');

            window.submitProduct = async function(e) {
                if (e) e.preventDefault();
                console.log('submitProduct invoked');
                const submitBtn = form.querySelector('.btn-submit');
                try {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 发布中...';

                    let finalImageUrl = document.getElementById('imageUrl').value;
                    const imageType = document.querySelector('input[name="imageType"]:checked').value;

                    if (imageType === 'file') {
                        const fileInput = document.getElementById('imageFile');
                        if (fileInput.files.length > 0) {
                            const formData = new FormData();
                            formData.append('image', fileInput.files[0]);
                            
                            const uploadRes = await fetch('/api/upload', {
                                method: 'POST',
                                body: formData
                            });
                            
                            if (!uploadRes.ok) throw new Error('图片上传失败');
                            
                            const uploadData = await uploadRes.json();
                            finalImageUrl = uploadData.imageUrl;
                        } else {
                             throw new Error('请选择要上传的图片');
                        }
                    } else {
                        if (!finalImageUrl) {
                            throw new Error('请输入图片链接');
                        }
                    }

                    // Determine merchant info
                    let merchantId, merchantName;
                    if (user.role === 'admin') {
                        const select = document.getElementById('merchantSelect');
                        merchantId = select.value;
                        if (!merchantId) throw new Error('请选择店铺');
                        merchantName = select.options[select.selectedIndex].getAttribute('data-name');
                    } else {
                        merchantId = user.id;
                        merchantName = document.getElementById('merchantName').value;
                    }

                    // Ensure productCode and merchantId exist to satisfy backend validation
                    let productCodeVal = (document.getElementById('productCode').value || '').trim();
                    if (!productCodeVal) {
                        // generate a fallback product code
                        productCodeVal = 'P' + Date.now().toString(36).toUpperCase().slice(-8);
                        console.log('Auto-generated productCode:', productCodeVal);
                    }

                    // merchantId fallback (hidden for merchant users)
                    const hiddenMerchantId = document.getElementById('merchantId')?.value;
                    if (!merchantId && hiddenMerchantId) {
                        merchantId = hiddenMerchantId;
                    }

                    const productData = {
                        name: document.getElementById('name').value,
                        price: parseFloat(document.getElementById('price').value),
                        stock: parseInt(document.getElementById('stock').value),
                        category: document.getElementById('category').value,
                        description: document.getElementById('description').value,
                        imageUrl: finalImageUrl,
                        productCode: productCodeVal,
                        searchKeywords: document.getElementById('searchKeywords').value,
                        merchant: merchantName,
                        merchantId: merchantId,
                        supplier: merchantName,
                        supplierId: merchantId
                    };

                    const response = await fetch('/api/products', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(productData)
                    });

                    if (!response.ok) {
                        let text = await response.text();
                        try { 
                            const json = JSON.parse(text);
                            throw new Error(json.message || '发布失败');
                        } catch (err) {
                            throw new Error('发布失败: 非 JSON 响应 => ' + text.substring(0,200));
                        }
                    }

                    alert('商品发布成功！');
                    window.location.href = '/products.html'; // 跳转到商品列表

                } catch (error) {
                    console.error('发布失败:', error);
                    alert('发布失败: ' + error.message);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> 立即发布';
                }
            };

            // 仍保留通过 form submit 触发的绑定
            form.addEventListener('submit', window.submitProduct);
        });
    </script>
</body>
</html>
