<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>惠多多 - 商家后台</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #667eea;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* 时间筛选按钮样式 */
        .date-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.3s ease;
        }

        .date-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .date-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .date-filter-container {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="nav-brand huiddo-brand" onclick="window.location.href='/'" style="cursor:pointer;">惠多多 后台</div>
        <div class="nav-actions">
            <!-- New Stats Nav Item -->
            <div class="nav-item"
                onclick="document.getElementById('statsSection').scrollIntoView({behavior: 'smooth'})">
                <i class="fas fa-chart-line"></i> 数据分析
            </div>
            <div class="nav-item" onclick="window.location.href='/'">
                <i class="fas fa-home"></i> 返回商城
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- New Visualization Section -->
        <div class="card" id="statsSection" style="margin-bottom: 30px;">
            <h2><i class="fas fa-chart-line"></i> 平台数据分析</h2>

            <!-- 时间段选择器 -->
            <div class="date-filter-container" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                    <!-- 快捷时间选项 -->
                    <div class="quick-date-buttons" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="date-btn" data-range="7" onclick="setDateRange(7)">近7天</button>
                        <button class="date-btn active" data-range="30" onclick="setDateRange(30)">近30天</button>
                        <button class="date-btn" data-range="90" onclick="setDateRange(90)">近3个月</button>
                        <button class="date-btn" data-range="365" onclick="setDateRange(365)">近1年</button>
                        <button class="date-btn" data-range="all" onclick="setDateRange('all')">全部</button>
                    </div>

                    <!-- 自定义时间范围 -->
                    <div style="display: flex; gap: 10px; align-items: center; margin-left: auto;">
                        <span style="color: #666; font-size: 14px;">自定义:</span>
                        <input type="date" id="startDate" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <span style="color: #999;">至</span>
                        <input type="date" id="endDate" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <button onclick="applyCustomDateRange()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                            <i class="fas fa-search"></i> 查询
                        </button>
                    </div>
                </div>
                <div id="currentDateRange" style="margin-top: 10px; font-size: 13px; color: #888;">
                    当前显示: <span id="dateRangeText">近30天</span>
                </div>
            </div>

            <div id="loadingStats">数据加载中...</div>
            <div id="statsContent" style="display:none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">总销售额</div>
                        <div class="stat-value" id="totalRevenue">¥0</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #2ecc71;">
                        <div class="stat-label">总订单数</div>
                        <div class="stat-value" id="totalOrders">0</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #f1c40f;">
                        <div class="stat-label">总用户/商家</div>
                        <div class="stat-value" id="totalUsers">0 / 0</div>
                    </div>
                    <div class="stat-card" style="border-left-color: #9b59b6;">
                        <div class="stat-label">日均销售额</div>
                        <div class="stat-value" id="avgDailyRevenue">¥0</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <div>
                        <h3 style="margin-bottom: 15px; color:#555;"><span id="trendChartTitle">近30日</span>销售趋势</h3>
                        <div class="chart-container">
                            <canvas id="salesTrendChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 15px; color:#555;">品类销售占比</h3>
                        <div class="chart-container">
                            <canvas id="categoryPieChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 新增：订单状态分布 -->
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px; color:#555;">订单状态分布</h3>
                    <div class="chart-container" style="max-width: 500px; margin: 0 auto; position: relative;">
                        <canvas id="orderStatusChart"></canvas>
                        <div id="orderStatusNoData" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #999; font-size: 14px;">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 10px; display: block; text-align: center;"></i>
                            <span>暂无订单数据</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-users"></i> 用户管理</h2>
            <div id="userList">
                <p>加载中...</p>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        // Admin check
        document.addEventListener('DOMContentLoaded', () => {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/login.html';
                return;
            }
            const user = JSON.parse(userStr);
            if (user.role !== 'admin') {
                alert('无权访问');
                window.location.href = '/';
            }

            fetchUsers();
            fetchAdminStats(); // Load stats
        });

        async function fetchUsers() {
            const list = document.getElementById('userList');
            try {
                const res = await fetch('/api/admin/users');
                const users = await res.json();

                if (users.length === 0) {
                    list.innerHTML = '<p>暂无用户</p>';
                    return;
                }

                list.innerHTML = users.map(u => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;">
                        <div>
                            <strong>${escapeHtml(u.name)}</strong> (${escapeHtml(u.email)})
                            <span style="background:#eee; padding:2px 6px; border-radius:4px; font-size:0.8rem; margin-left:5px;">${u.role}</span>
                        </div>
                        ${u.role !== 'admin' ? `<button onclick="deleteUser('${u._id}')" style="background:#e74c3c; padding:5px 10px; font-size:0.9rem;">删除</button>` : ''}
                    </div>
                `).join('');
            } catch (err) {
                list.innerHTML = '<p style="color:red">加载失败</p>';
            }
        }

        async function deleteUser(id) {
            if (!confirm('确定要删除该用户吗？')) return;
            try {
                const res = await fetch(`/api/admin/users/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    fetchUsers();
                } else {
                    alert('删除失败');
                }
            } catch (err) {
                alert('网络错误');
            }
        }
        // 全局变量：存储当前筛选的时间范围（默认改为30天以显示更多种子数据）
        let currentDateRange = { days: 30, startDate: null, endDate: null };
        let salesTrendChart = null;
        let categoryPieChart = null;
        let orderStatusChart = null;

        // 设置快捷时间范围
        function setDateRange(days) {
            // 更新按钮状态
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.date-btn[data-range="${days}"]`).classList.add('active');

            // 更新当前范围
            currentDateRange = { days, startDate: null, endDate: null };

            // 更新显示文本
            const rangeTexts = {
                7: '近7天',
                30: '近30天',
                90: '近3个月',
                365: '近1年',
                'all': '全部时间'
            };
            document.getElementById('dateRangeText').textContent = rangeTexts[days] || `近${days}天`;
            document.getElementById('trendChartTitle').textContent = rangeTexts[days] || `近${days}日`;

            // 清空自定义日期输入
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';

            // 重新获取数据
            fetchAdminStats();
        }

        // 应用自定义时间范围
        function applyCustomDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                Swal.fire('提示', '请选择开始和结束日期', 'warning');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                Swal.fire('提示', '开始日期不能晚于结束日期', 'warning');
                return;
            }

            // 更新按钮状态
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('active'));

            // 更新当前范围
            currentDateRange = { days: null, startDate, endDate };

            // 更新显示文本
            document.getElementById('dateRangeText').textContent = `${startDate} 至 ${endDate}`;
            document.getElementById('trendChartTitle').textContent = '自定义时间段';

            // 重新获取数据
            fetchAdminStats();
        }

        async function fetchAdminStats() {
            try {
                // 构建查询参数
                const params = new URLSearchParams();
                if (currentDateRange.days && currentDateRange.days !== 'all') {
                    params.append('days', currentDateRange.days);
                } else if (currentDateRange.startDate && currentDateRange.endDate) {
                    params.append('startDate', currentDateRange.startDate);
                    params.append('endDate', currentDateRange.endDate);
                }

                const res = await fetch(`/api/admin/stats?${params.toString()}`);
                if (!res.ok) throw new Error('Failed to fetch stats');
                const data = await res.json();

                // Render Stat Cards
                document.getElementById('totalRevenue').textContent = '¥' + data.totalRevenue.toFixed(2);
                document.getElementById('totalOrders').textContent = data.totalOrders;
                document.getElementById('totalUsers').textContent = `${data.totalUsers} / ${data.totalMerchants}`;

                // 计算并显示日均销售额
                const avgDaily = data.salesTrend && data.salesTrend.length > 0
                    ? (data.totalRevenue / data.salesTrend.length).toFixed(2)
                    : '0.00';
                document.getElementById('avgDailyRevenue').textContent = '¥' + avgDaily;

                // Show content
                document.getElementById('loadingStats').style.display = 'none';
                document.getElementById('statsContent').style.display = 'block';

                // Render Charts
                renderCharts(data);
            } catch (err) {
                console.error(err);
                document.getElementById('loadingStats').textContent = '数据加载失败';
            }
        }

        function renderCharts(data) {
            // 销毁旧图表（避免重复创建）
            if (salesTrendChart) {
                salesTrendChart.destroy();
                salesTrendChart = null;
            }
            if (categoryPieChart) {
                categoryPieChart.destroy();
                categoryPieChart = null;
            }
            if (orderStatusChart) {
                orderStatusChart.destroy();
                orderStatusChart = null;
            }

            // Trend Chart - 销售趋势
            const ctxTrend = document.getElementById('salesTrendChart').getContext('2d');
            const dates = data.salesTrend.map(item => item._id);
            const amounts = data.salesTrend.map(item => item.amount);

            salesTrendChart = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: '销售额',
                        data: amounts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Pie Chart
            const ctxPie = document.getElementById('categoryPieChart').getContext('2d');

            // Map category names
            const categoryMap = {
                'Electronics': '电子产品',
                'Clothing': '服装',
                'Books': '书籍',
                'Home': '家居',
                'Beauty': '美妆'
            };

            const labels = data.categoryStats.map(item => categoryMap[item._id] || item._id || '其他');
            const sales = data.categoryStats.map(item => item.sales);

            categoryPieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: sales,
                        backgroundColor: [
                            '#ff6b6b', '#4ecdc4', '#ffe66d', '#1a535c', '#ff9f43'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Order Status Chart - 订单状态分布
            const orderStatusNoData = document.getElementById('orderStatusNoData');
            const orderStatusCanvas = document.getElementById('orderStatusChart');

            if (data.orderStatusStats && data.orderStatusStats.length > 0) {
                // 有数据，显示图表
                orderStatusNoData.style.display = 'none';
                orderStatusCanvas.style.display = 'block';

                const ctxStatus = orderStatusCanvas.getContext('2d');

                // 订单状态映射
                const statusMap = {
                    '待支付': { label: '待支付', color: '#f39c12' },
                    '已支付': { label: '已支付', color: '#3498db' },
                    '发货中': { label: '发货中', color: '#9b59b6' },
                    '已完成': { label: '已完成', color: '#27ae60' },
                    '已取消': { label: '已取消', color: '#95a5a6' },
                    '已退款': { label: '已退款', color: '#e74c3c' }
                };

                const statusLabels = data.orderStatusStats.map(item =>
                    statusMap[item._id]?.label || item._id || '未知'
                );
                const statusCounts = data.orderStatusStats.map(item => item.count);
                const statusColors = data.orderStatusStats.map(item =>
                    statusMap[item._id]?.color || '#bdc3c7'
                );

                orderStatusChart = new Chart(ctxStatus, {
                    type: 'pie',
                    data: {
                        labels: statusLabels,
                        datasets: [{
                            data: statusCounts,
                            backgroundColor: statusColors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.raw / total) * 100).toFixed(1);
                                        return `${context.label}: ${context.raw} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                // 无数据，显示提示
                orderStatusNoData.style.display = 'block';
                orderStatusCanvas.style.display = 'none';
            }
        }
    </script>
</body>

</html>
