<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>惠多多 - 店铺管理</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .shops-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .shop-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            position: relative;
        }
        .shop-card:hover {
            transform: translateY(-5px);
        }
        .shop-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .shop-icon {
            width: 50px;
            height: 50px;
            background: #f0f2f5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #3498db;
        }
        .shop-info h3 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }
        .shop-rating {
            color: #f1c40f;
            font-size: 14px;
        }
        .shop-desc {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 15px;
            height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .shop-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
        }
        .btn-edit {
            background: #3498db;
            color: white;
        }
        .btn-delete {
            background: #e74c3c;
            color: white;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand huiddo-brand" onclick="window.location.href='/'" style="cursor:pointer;">惠多多</div>
        <div class="nav-actions">
            <div class="nav-item" onclick="window.location.href='/'">
                <i class="fas fa-home"></i> 返回首页
            </div>
        </div>
    </nav>

    <div class="container shops-container">
        <div class="header-actions">
            <h2><i class="fas fa-store"></i> 店铺管理</h2>
            <button class="btn-primary" onclick="openModal()" style="padding: 10px 20px; border-radius: 5px; border: none; background: #2ecc71; color: white; cursor: pointer;">
                <i class="fas fa-plus"></i> 新增店铺
            </button>
        </div>

        <div id="shopList" class="shop-grid">
            <!-- Shops will be loaded here -->
        </div>
    </div>

    <!-- Add/Edit Shop Modal -->
    <div id="shopModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" style="margin-top: 0;">新增店铺</h3>
            <form id="shopForm">
                <input type="hidden" id="shopId">
                <div class="form-group">
                    <label>店铺名称</label>
                    <input type="text" id="shopName" required>
                </div>
                <div class="form-group">
                    <label>店主姓名</label>
                    <input type="text" id="ownerName" required>
                </div>
                <div class="form-group">
                    <label>登录邮箱</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group" id="passwordGroup">
                    <label>登录密码</label>
                    <input type="password" id="password" placeholder="新建时必填，修改时留空不改">
                </div>
                <div class="form-group">
                    <label>联系电话</label>
                    <input type="text" id="phone">
                </div>
                <div class="form-group">
                    <label>店铺简介</label>
                    <textarea id="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>店铺星级 (0-5)</label>
                    <input type="number" id="rating" min="0" max="5" step="0.1" value="5.0">
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" onclick="closeModal()" style="padding: 8px 15px; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">取消</button>
                    <button type="submit" style="padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/login.html';
                return;
            }
            currentUser = JSON.parse(userStr);
            if (currentUser.role !== 'admin') {
                alert('只有管理员可以访问此页面');
                window.location.href = '/';
                return;
            }
            loadShops();
        });

        async function loadShops() {
            try {
                const response = await fetch('/api/merchants');
                const shops = await response.json();
                const container = document.getElementById('shopList');
                
                container.innerHTML = shops.map(shop => `
                    <div class="shop-card">
                        <div class="shop-header">
                            <div class="shop-icon">
                                <i class="fas fa-store"></i>
                            </div>
                            <div class="shop-info">
                                <h3>${shop.merchantInfo?.shopName || shop.name}</h3>
                                <div class="shop-rating">
                                    ${getStarRating(shop.merchantInfo?.rating || 5)}
                                    <span>(${shop.merchantInfo?.rating || 5.0})</span>
                                </div>
                            </div>
                        </div>
                        <div class="shop-desc">
                            ${shop.merchantInfo?.shopDescription || '暂无简介'}
                        </div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                            <div><i class="fas fa-user"></i> 店主: ${shop.name}</div>
                            <div><i class="fas fa-envelope"></i> ${shop.email}</div>
                            <div><i class="fas fa-phone"></i> ${shop.merchantInfo?.contactPhone || '未填写'}</div>
                        </div>
                        <div class="shop-actions">
                            <button class="btn-sm btn-edit" onclick='editShop(${JSON.stringify(shop).replace(/'/g, "&#39;")})'>
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn-sm btn-delete" onclick="deleteShop('${shop._id}')">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载店铺失败:', error);
                alert('加载店铺失败');
            }
        }

        function getStarRating(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            let html = '';
            for (let i = 0; i < fullStars; i++) html += '<i class="fas fa-star"></i>';
            if (hasHalfStar) html += '<i class="fas fa-star-half-alt"></i>';
            return html;
        }

        function openModal(shop = null) {
            const modal = document.getElementById('shopModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('shopForm');
            
            if (shop) {
                title.textContent = '编辑店铺';
                document.getElementById('shopId').value = shop._id;
                document.getElementById('shopName').value = shop.merchantInfo?.shopName || '';
                document.getElementById('ownerName').value = shop.name;
                document.getElementById('email').value = shop.email;
                document.getElementById('email').disabled = true; // Email cannot be changed
                document.getElementById('password').required = false;
                document.getElementById('phone').value = shop.merchantInfo?.contactPhone || '';
                document.getElementById('description').value = shop.merchantInfo?.shopDescription || '';
                document.getElementById('rating').value = shop.merchantInfo?.rating || 5.0;
            } else {
                title.textContent = '新增店铺';
                form.reset();
                document.getElementById('shopId').value = '';
                document.getElementById('email').disabled = false;
                document.getElementById('password').required = true;
            }
            
            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('shopModal').style.display = 'none';
        }

        window.editShop = function(shop) {
            openModal(shop);
        };

        window.deleteShop = async function(id) {
            if (!confirm('确定要删除该店铺吗？这将同时删除该店铺下的所有商品！')) return;
            
            try {
                const response = await fetch(`/api/merchants/${id}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    alert('删除成功');
                    loadShops();
                } else {
                    alert('删除失败');
                }
            } catch (error) {
                console.error(error);
                alert('删除出错');
            }
        };

        document.getElementById('shopForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('shopId').value;
            const data = {
                name: document.getElementById('ownerName').value,
                email: document.getElementById('email').value,
                shopName: document.getElementById('shopName').value,
                shopDescription: document.getElementById('description').value,
                contactPhone: document.getElementById('phone').value,
                rating: parseFloat(document.getElementById('rating').value)
            };
            
            const password = document.getElementById('password').value;
            if (password) data.password = password;

            try {
                const url = id ? `/api/merchants/${id}` : '/api/merchants';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('保存成功');
                    closeModal();
                    loadShops();
                } else {
                    const err = await response.json();
                    alert('保存失败: ' + err.message);
                }
            } catch (error) {
                console.error(error);
                alert('保存出错');
            }
        });

        // Close modal when clicking outside
        document.getElementById('shopModal').addEventListener('click', (e) => {
            if (e.target.id === 'shopModal') closeModal();
        });
    </script>
</body>
</html>
